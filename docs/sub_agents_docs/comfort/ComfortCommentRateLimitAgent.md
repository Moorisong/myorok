# Comfort Comment Rate Limit Agent Reference

> 쉼터 탭 댓글 빈도 제한 기능 전담 에이전트

## COMFORT_SPEC.md (관련 섹션)

### 2.2 댓글 - 빈도 제한 정책 (Rate Limit)

**정책 원칙**: 자연스러운 대화형 댓글 흐름 유지 + 스팸/도배 방지

| 항목 | 값 |
|------|------|
| 기준 | userId + postId |
| 최소 간격 | 30초 |
| 단기 제한 | 5분 내 최대 3개 |

**서버 검증**:
- 마지막 댓글 작성 시점 < 현재 - 30초
- 최근 5분 내 댓글 개수 ≤ 3
- 조건 충족 시 댓글 생성, 초과 시 `429 Too Many Requests` 반환

**에러 응답 (429)**:
```json
{
  "code": "COMMENT_RATE_LIMIT",
  "message": "댓글은 잠시 후 다시 작성할 수 있습니다.",
  "retryAfter": 30
}
```

**프론트엔드 UX**:
- 댓글 작성 성공 후 입력창 비활성화 (30초 쿨타임)
- 남은 시간 카운트다운 표시
- 429 에러 수신 시 `retryAfter` 기준으로 타이머 동기화
- 안내 문구: "잠시 후 다시 댓글을 작성할 수 있어요 (30초)"

---

## API 명세

### POST /api/comfort/posts/:id/comments (댓글 작성)

**Request Body**:
```json
{
  "content": "string"
}
```

**서버 처리 로직**:
1. 인증 토큰에서 `userId` (또는 `deviceId`) 추출
2. `userId + postId` 기준 최근 댓글 목록 조회
3. 빈도 제한 검사:
   - 마지막 댓글 작성 시점 < 현재 - 30초
   - 최근 5분 내 댓글 개수 ≤ 3
4. 조건 충족 시 댓글 생성
5. 초과 시 요청 거절

**응답 (성공)**:
```http
201 Created
```

**응답 (빈도 제한 초과)**:
```http
429 Too Many Requests
```
```json
{
  "code": "COMMENT_RATE_LIMIT",
  "message": "댓글은 잠시 후 다시 작성할 수 있습니다.",
  "retryAfter": 30
}
```

---

## AI 작업 지침

### 목적
자연스러운 대화형 댓글 흐름을 유지하면서 스팸과 도배를 효과적으로 방지합니다.

### 작업 단계

#### 1. 백엔드 빈도 제한 로직 구현
- `POST /api/comfort/posts/:id/comments` API에 빈도 제한 검증 추가
- **검증 1: 최소 간격 (30초)**
  - 해당 userId의 해당 postId 최근 댓글 조회
  - 마지막 댓글 createdAt과 현재 시간 비교
  - 30초 미만이면 `429` 반환
- **검증 2: 단기 제한 (5분 내 3개)**
  - 최근 5분 내 작성한 댓글 개수 카운트
  - 3개 이상이면 `429` 반환
- 429 응답 시 `retryAfter` 필드 포함 (고정값 30 또는 계산값)
- **서버 시간 기준 필수**: 클라이언트 시간 신뢰 금지

#### 2. 프론트엔드 쿨타임 UI 구현
- 댓글 작성 성공 후:
  - 입력창 즉시 비활성화
  - 30초 카운트다운 타이머 시작
  - 타이머 표시: "잠시 후 다시 댓글을 작성할 수 있어요 (30초)"
  - 타이머 종료 시 입력창 자동 활성화
- 429 에러 수신 시:
  - 서버의 `retryAfter` 값으로 타이머 동기화
  - 클라이언트 타이머가 틀릴 경우 서버 값으로 보정
- 안드로이드 백그라운드 진입 시:
  - 타이머 상태 유지 (AsyncStorage 등)
  - 복귀 시 경과 시간 계산하여 재설정

#### 3. 에러 처리 및 UX
- **429 에러 메시지**
  - Toast로 "댓글은 잠시 후 다시 작성할 수 있습니다." 표시
  - 입력창 아래 카운트다운 타이머 노출
- **네트워크 에러**
  - 일반적인 재시도 로직
- **사용자 피드백**
  - 쿨타임 중임을 명확히 인지시킴
  - 남은 시간을 실시간으로 표시

#### 4. 성능 최적화
- 빈도 제한 조회 시 인덱스 활용
  - `userId`, `postId`, `createdAt` 복합 인덱스
- Redis 등 인메모리 캐시 고려 (추후 확장)
  - 각 userId+postId별 마지막 작성 시간 캐싱
  - 5분 TTL로 최근 댓글 개수 캐싱

### 주의사항

#### 서버 기준 필수
- **절대 원칙**: 클라이언트 시간 신뢰 금지
- 프론트엔드 제한은 UX 보조용
- 최종 판단은 서버에서만

#### 429 응답 필수 사항
- HTTP 상태 코드: `429 Too Many Requests`
- 응답 Body에 `retryAfter` 필드 필수
- 명확한 에러 메시지

#### 정책 일관성
- 30초 최소 간격 고정
- 5분 내 3개 고정
- 변경 시 서버/클라이언트 동시 업데이트

#### Android 전용
- iOS 관련 코드 금지
- React Native 코드는 Android만 고려
- 백그라운드 타이머 처리 주의

#### 테스트 케이스
- [ ] 30초 이내 재작성 시 429 반환
- [ ] 5분 내 4번째 댓글 작성 시 429 반환
- [ ] 30초 대기 후 정상 작성 가능
- [ ] 5분 경과 후 카운터 리셋
- [ ] 429 에러 수신 시 타이머 동기화
- [ ] 백그라운드 진입/복귀 시 타이머 유지
