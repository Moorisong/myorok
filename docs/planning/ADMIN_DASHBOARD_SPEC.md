# 🔐 운영자 계정 & 📊 운영자 대시보드 명세 (MVP)

> **반려묘 병상일지 앱 – 묘록**  
> **목적**  
> - 운영자만 접근 가능한 대시보드 제공  
> - 구독 기반 서비스 상태를 **5초 안에 파악**  
> - 차트 없이 **숫자 카드 중심** 구성

---

## 1. 운영자 계정 설계

### 1.1 운영자 식별 방식

| 항목 | 내용 |
|------|------|
| 기준 | 카카오 로그인 userId |
| 관리 | 서버 환경변수에 등록된 ID만 운영자로 인정 |
| 관리자 테이블 | ❌ (MVP 범위 제외) |

### 1.2 환경변수 설정

```env
ADMIN_KAKAO_IDS=123456789,987654321
```

| 항목 | 설명 |
|------|------|
| 값 | 카카오 userId |
| 형식 | 콤마(,)로 복수 등록 |
| 관리 위치 | 서버 `.env` |

---

## 2. 서버 권한 판별

### 2.1 운영자 판별 로직

```typescript
function isAdminUser(kakaoUserId: string): boolean {
  const admins = process.env.ADMIN_KAKAO_IDS?.split(",") ?? [];
  return admins.includes(kakaoUserId);
}
```

### 2.2 로그인 API 응답 확장

```json
{
  "userId": "123456789",
  "isAdmin": true,
  "subscriptionStatus": "active"
}
```

| 항목 | 설명 |
|------|------|
| `isAdmin` | 서버에서만 판단 |
| 보안 | 프론트에서 임의 조작 불가 |

---

## 3. 앱 UI – 운영자 진입 UX

### 3.1 버튼 노출 위치

- **설정(Settings) 탭 하단**
- 일반 설정과 시각적으로 분리

### 3.2 버튼 노출 조건

```typescript
isAdmin === true
```

### 3.3 버튼 텍스트

```
운영자 대시보드
```

---

## 4. 운영자 대시보드 개요

### 4.1 목적

- 서비스 성장/정체/감소 여부 **즉시 판단**
- MAU ❌, 설치 수 ❌
- **구독 중심 지표만** 노출

### 4.2 구성 원칙

| 항목 | 원칙 |
|------|------|
| UI | 숫자 카드(Card) |
| 차트 | 사용 안 함 |
| 단위 | 명 / 원 / % 명확히 표시 |
| 갱신 | 화면 진입 시 최신 데이터 로드 |

---

## 5. 대시보드 레이아웃

```
┌────────────────────────────────────┐
│  상단 – 핵심 지표 (KPI)            │
├────────────────────────────────────┤
│  중단 – 전환 지표                   │
├────────────────────────────────────┤
│  하단 – 보조 지표                   │
└────────────────────────────────────┘
```

---

## 6. 상단 영역 – 핵심 지표 (KPI)

> 이 앱의 상태를 가장 정확히 보여주는 지표

### 6.1 현재 유효 구독 수

| 항목 | 내용 |
|------|------|
| 설명 | 현재 시점 만료되지 않은 구독 수 |
| 기준 | `subscriptionStatus = active` |
| 표시 예 | `128명` |
| 중요도 | ★★★★★ |

### 6.2 이번 달 월 구독 매출 (MRR)

| 항목 | 내용 |
|------|------|
| 설명 | 이번 달 확정된 정기 구독 매출 |
| 계산식 | `유효 구독 수 × 3,500원` |
| 표시 예 | `448,000원` |
| 중요도 | ★★★★★ |

### 6.3 지난달 대비 증감률

| 항목 | 내용 |
|------|------|
| 설명 | 지난달 대비 유효 구독 수 증감 비율 |
| 계산식 | `(이번 달 - 지난달) / 지난달 × 100` |
| 표시 예 | `+12%`, `-5%` |
| 중요도 | ★★★★☆ |

---

## 7. 중단 영역 – 전환 지표

> 무료 체험 → 유료 전환 흐름 확인

### 7.1 체험 사용자 수

| 항목 | 내용 |
|------|------|
| 설명 | 현재 무료 체험(7일) 상태 사용자 수 |
| 기준 | `subscriptionStatus = trial` |
| 표시 예 | `42명` |

### 7.2 체험 → 결제 전환율

| 항목 | 내용 |
|------|------|
| 설명 | 체험 종료 후 실제 결제로 이어진 비율 |
| 계산식 | `체험 후 결제 수 / 전체 체험 수 × 100` |
| 표시 예 | `18%` |

---

## 8. 하단 영역 – 보조 지표

> 참고용 지표 (의사결정 보조)

### 8.1 총 기기 수

| 항목 | 내용 |
|------|------|
| 설명 | 앱을 한 번이라도 실행한 전체 기기 수 |
| 기준 | `deviceId` 기준 |
| 표시 예 | `1,024대` |

### 8.2 최근 7일 신규 기기 수

| 항목 | 내용 |
|------|------|
| 설명 | 최근 7일 내 최초 실행된 기기 수 |
| 표시 예 | `56대` |

---

## 9. 접근 제어 (보안)

### 9.1 앱 레벨

| 조건 | 동작 |
|------|------|
| 일반 사용자 | 버튼 미노출 |
| 직접 URL 접근 | 접근 불가 화면 표시 |

### 9.2 서버 레벨 (필수)

```typescript
function requireAdmin(req: Request, res: Response, next: NextFunction) {
  if (!req.user?.isAdmin) {
    return res.status(403).json({ message: "FORBIDDEN" });
  }
  next();
}

// 적용: 모든 /admin/* API
```

---

## 10. API 명세

### 10.1 로그인 응답 확장

```
POST /api/auth/login
```

**Response:**
```json
{
  "userId": "123456789",
  "nickname": "집사",
  "isAdmin": true,
  "subscriptionStatus": "active"
}
```

### 10.2 대시보드 지표 조회

```
GET /api/admin/dashboard
```

**Headers:**
```
Authorization: Bearer {jwt_token}
```

**Response:**
```json
{
  "kpi": {
    "activeSubscriptions": 128,
    "monthlyRevenue": 448000,
    "growthRate": 12.5
  },
  "conversion": {
    "trialUsers": 42,
    "conversionRate": 18.0
  },
  "secondary": {
    "totalDevices": 1024,
    "newDevices7Days": 56
  }
}
```

### 10.3 접근 권한 오류

```json
{
  "message": "FORBIDDEN"
}
```
**HTTP Status:** 403

---

## 11. 데이터 구조

### 11.1 필요 데이터

| 지표 | 데이터 소스 |
|------|------------|
| 유효 구독 수 | `subscription_state` (status = active) |
| 체험 사용자 수 | `subscription_state` (status = trial) |
| 총 기기 수 | `devices` 컬렉션 |
| 신규 기기 | `devices.createdAt` 기준 |
| 전환율 | `subscription_logs` (체험→결제 이력) |

### 11.2 새로 필요한 컬렉션

#### subscription_logs

```json
{
  "_id": "ObjectId",
  "userId": "string",
  "previousStatus": "trial",
  "newStatus": "active",
  "changedAt": "ISODate"
}
```

---

## 12. MVP 범위 정리

| 항목 | 포함 여부 |
|------|----------|
| 운영자 계정 환경변수 관리 | ✅ |
| 운영자 전용 대시보드 | ✅ |
| 구독 중심 숫자 카드 지표 | ✅ |
| 차트 | ❌ |
| 상세 사용자 분석 | ❌ |
| 관리자 권한 레벨 분리 | ❌ |

---

## 13. 요약

> **이 대시보드는**  
> "이번 달에도 이 서비스가 굴러가고 있는가?"를  
> **한눈에 보여주는 화면**이다.
