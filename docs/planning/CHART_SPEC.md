# 📊 Chart & Analysis Specification (Integrated)

> **통합 문서 안내**
> 본 문서는 기존에 파편화되어 있던 아래 문서들을 통합 및 최신화한 것입니다.
> - `OVERALL_SUMMARY_SPEC.md`, `3M_CHART_SPEC.md`, `MEDICINE_CHART_SPEC.md`, `CHART_IMPROVEMENT_SPEC.md`
>
> **적용 대상**: `/charts/summary` (병원용 요약 차트) 및 `/charts/custom` 일부

---

## 1. 개요 및 설계 원칙

### 1.1 목적
반려묘의 건강 기록을 **기간별 목적에 맞게 시각화**하여, 보호자와 의료진이 직관적으로 상태를 파악할 수 있도록 한다.

### 1.2 핵심 원칙
1.  **기간에 따른 표현 변화**: 기간이 길어질수록 "상세 기록"에서 "패턴/요약"으로 표현 방식을 변경한다.
2.  **의료적 오해 방지**: 이벤트성 데이터(구토, 설사 등)를 연속 데이터(Line Chart)로 표현하지 않는다.
3.  **숫자 중심**: 그래프를 해석하지 않아도 정확한 수치를 읽을 수 있어야 한다.
4.  **스크롤 및 탐색**: 모바일 환경을 고려하여 적절한 스크롤 영역과 고정 영역을 분리한다.

---

## 2. 기간별 표현 전략 (Period Strategy)

| 기간 | 주요 목적 | 표현 방식 (밀도) |
| :-- | :-- | :-- |
| **15일 (15d)** | 상세 확인 | **일 단위 (Daily)** <br> - Dot Chart (증상) <br> - Bar Chart (수액) <br> - Timeline (약) |
| **1개월 (1m)** | 최근 추이 | **일 단위 (Daily)** <br> (15일과 동일, 표시 개수만 증가) |
| **3개월 (3m)** | 문제 구간 파악 | **주 단위 (Weekly Aggregation)** <br> - Bar Chart (주간 합계) <br> - Weekly Summary Bar (약) |
| **전체 (All)** | 종합 평가 | **통계 카드 (Stats Only)** <br> - 차트 없음 <br> - 텍스트/숫자 기반 요약 리포트 |

---

## 3. 증상 차트 (Symptoms: 배변/설사/구토)

### 3.1 15일 / 1개월 (Daily View)
-   **차트 타입**: **Dot Chart** (점 차트)
-   **데이터 속성**: 이산 데이터 (Discrete). 0인 날은 표시하지 않음.
-   **표현 규칙**:
    -   X축: 날짜 (MM/DD)
    -   Y축: 횟수 (Counts)
    -   **수치 표시**: 점 바로 위에 숫자 고정 표시 (예: "3")
    -   **연결 금지**: 점과 점 사이를 선으로 연결하지 않음.

### 3.2 3개월 (Weekly View)
-   **차트 타입**: **Bar Chart** (막대 차트)
-   **데이터 속성**: 주간 합계 (Weekly Sum).
-   **표현 규칙**:
    -   X축: 주차 (W1 ~ W12)
    -   Y축: 주간 총 발생 횟수
    -   **수치 표시**: 막대 상단에 총 횟수 표시
    -   **해석**: "이 주에 유난히 증상이 잦았다"를 파악하는 용도.

### 3.3 전체 (Summary View)
-   **차트 없음**
-   **형태**: `증상 요약 카드`
-   **표시 항목**:
    -   구토: 누적 횟수
    -   설사: 발생 일수 (횟수 아님)
    -   평균 배변: (전체 배변 횟수 / 기록 일수)

---

## 4. 강수 / 수액 차트 (Fluids)

### 4.1 15일 / 1개월 (Daily View)
-   **차트 타입**: **Bar Chart** (독립 막대)
-   **데이터 속성**: 일별 총 투여량 (ml).
-   **표현 규칙**:
    -   타입 구분: 💧 강수 / 💉 수액 (색상/아이콘 구분)
    -   같은 날 다회 투여 시: 합산하여 하나의 막대로 표시.
    -   **수치 표시**: 막대 상단에 `N ml` 표시.

### 4.2 3개월 (Weekly View)
-   **차트 타입**: **Bar Chart** (주간 합계)
-   **데이터 속성**: 주간 총 투여량.
-   **해석**: 수액 투여 빈도와 강도가 높은 주간을 식별.

### 4.3 전체 (Summary View)
-   **차트 없음**
-   **형태**: `강수 / 수액 요약 카드`
-   **표시 항목**:
    -   총 강수량 (ml)
    -   총 수액량 (ml)
    -   전체 투여량 합계

---

## 5. 약 / 영양제 차트 (Medicines)

### 5.1 15일 / 1개월 (Daily Timeline)
> **목적**: 복용 성실도(Adherence) 및 연속성 확인

-   **구조**: 약물별 Row (가로 타임라인)
-   **표현 방식 (Adaptive)**:
    1.  **연속 복용(Continuous)**: 끊김 없는 기간 → **이어진 막대(Bar)** 로 표시.
    2.  **비연속 복용(Intermittent)**: 띄엄띄엄 복용 → **개별 점(Dot)** 로 표시.
-   **UX**:
    -   의료진이 "꾸준히 먹였는지" vs "가끔 먹였는지" 1초 만에 파악 가능해야 함.
    -   빈 날짜는 명확히 비워둠 (가짜 연결 금지).

### 5.2 3개월 (Weekly Summary)
> **목적**: "정확한 날짜"보다 **"복용 패턴(지속/중단)"** 파악

-   **구조**: 약물별 Row, 주(Week) 단위 블록 (총 12~13주)
-   **표현 방식 (Density Bar)**:
    -   **0일**: 표시 안함
    -   **1~2일**: 연한 Bar (Opacity Low)
    -   **3~5일**: 기본 Bar (Opacity Medium)
    -   **6~7일**: 진한 Bar (Opacity High)
-   **특징**:
    -   Bar의 길이는 모든 주에서 **동일** (색 농도로 밀도 표현)
    -   왼쪽(과거) → 오른쪽(최근)
    -   **연속 복용 = Bar**, **단발 복용 = 점** 개념을 **주 단위 Bar**로 단순화
-   **해석**:
    -   "3개월 동안 꾸준히 먹었는지"
    -   "중간에 끊긴 구간이 있는지"를 직관적으로 파악
-   **데이터 구조 (권장)**:
    ```typescript
    weekSegments: {
      days: number; // 해당 주에 복용한 일수 (0~7)
    }[];
    // 프론트에서는 days 값만 사용하여 농도 결정
    ```
-   **삭제/비활성 약 처리**:
    -   Bar 색상을 비활성 색상(Gray)으로 표시
    -   약 이름에 `(삭제)` 표시
-   **설명 문구**: "3개월 차트는 주 단위 요약입니다. 해당 주에 복용한 날이 많을수록 막대가 진하게 표시됩니다."

### 5.3 전체 (Summary Report)
> **목적**: 전체 복용 이력 요약

-   **형태**: 텍스트 리스트
-   **표시 항목**:
    -   복용 약물명
    -   기간: 시작일 ~ 종료일
    -   총 복용일 수
    -   평균 빈도 (예: "주 4.2회")

---

## 6. 전체 통계 (Summary All Period)

기간을 **'전체(All)'** 로 선택 시, 스크롤되는 차트 대신 **정적인 리포트 화면**을 제공한다.

### 6.1 구성 요소 (Stat Cards)
1.  **기록 기간 카드**
    -   최초 기록일 ~ 마지막 기록일
    -   총 기간 (일수)
2.  **증상 요약 카드** (3.3 참조)
3.  **강수/수액 요약 카드** (4.3 참조)
4.  **관리 밀도 카드**
    -   기록된 날짜 수 / 총 기간 = 기록률(%)
    -   "얼마나 꾸준히 관리했는가" 지표

---

## 7. 구현 가이드라인 (summary.tsx)

### 7.1 데이터 로딩
-   `Period` 변경 시 기존 데이터 `clear` 후 로딩 (깜빡임 허용, 데이터 혼동 방지).
-   `All` 모드일 경우: 전체 기간 `DailyRecords`를 가져와 클라이언트 사이드에서 집계(Aggregation) 수행. (DB 부하 고려 시 추후 쿼리 최적화 가능)

### 7.2 차트 렌더링 분기
```typescript
{period === 'all' ? (
  <OverallSummaryCards data={summaryData} />
) : period === '3m' ? (
  <WeeklyChartScrollView data={weeklyData} />
) : (
  <DailyChartScrollView data={dailyData} />
)}
```

### 7.3 공통 UI 규칙
-   **스크롤**: 데이터가 로드되면 자동으로 **가장 최신 날짜(우측 끝)** 로 스크롤 이동.
-   **숫자 가독성**: 폰트 사이즈 10~12px 유지, 배경 대비 명확한 색상 사용.
-   **빈 데이터 처리**:
    -   15d/1m/3m: "기록 없음" 텍스트 표시.
    -   All: 데이터가 하나도 없으면 "기록이 충분하지 않습니다" 안내.

---

## 8. Custom Metrics Chart (Adaptive Chart)

> **적용 대상**: `/charts/custom` (사용자 정의 지표 차트)
> **목표**: 데이터가 많아져도 시각적으로 깔끔하게 차트를 표시하고, 기록량에 따라 차트 유형 및 집계 단위를 자동 조정

### 8.1 Adaptive Chart 전략

| 데이터 기간 | 데이터 개수 | 차트 유형 | 집계 단위 | 비고 |
|-------------|------------|-----------|-----------|------|
| **최근 15일 / 1개월** | ≤ 60 | Dot Chart / Line Chart | 일 단위 | 점 위 값 표시, 상세 데이터 확인 가능 |
| **1~3개월** | 61~180 | Line Chart / Area Chart | 주 단위 평균 | 점 생략, 선/영역 강조, Tooltip으로 값 확인 |
| **3~12개월** | 181~730 | Bar Chart / Line Chart | 주 단위 합계/평균 | 주간 추세 강조, 값 Tooltip 제공 |
| **1년 이상** | >730 | Sparklines / 요약 카드 | 월 단위 평균/합계 | 최소/최대/평균 표시, 큰 추세 중심 |

> ⚠️ 모든 기간에서 Tooltip 혹은 클릭 시 **일 단위 값 조회** 가능하도록 구현

---

## 9. Custom Metrics UI/UX 개선

### 9.1 기간 선택 UI
-   **선택 옵션**: 최근 1주, 1개월, 3개월, 6개월, 1년, 전체
-   선택 시 차트 유형 및 집계 단위 **자동 적용**

### 9.2 줌/스크롤 기능
-   전체 기간 차트에서 일부 영역 확대 가능
-   확대 시 단위가 자동으로 `주 → 일`로 변경

### 9.3 데이터 포인트 표시
-   밀도가 높으면 점 생략
-   마우스 오버/터치 시 Tooltip으로 값 표시

### 9.4 요약 카드
-   전체 기간 또는 긴 기간 데이터 시 `최소 / 최대 / 평균` 표시
-   필요 시 `최근 변화 추세` 아이콘 표시 (↑↓→)

---

## 10. Custom Metrics DB / 서비스 함수 개선

### 10.1 집계 관련 함수 추가

```typescript
// 기간별 집계 조회
getMetricRecordsAggregated(
  metricId: string, 
  startDate: string, 
  endDate: string, 
  unit: 'day' | 'week' | 'month'
): Promise<AggregatedRecord[]>

// 반환값 예시
interface AggregatedRecord {
  date: string;   // "2026-01-01" (일) 또는 "2026-W01" (주) 또는 "2026-01" (월)
  value: number;  // 집계된 값 (평균 또는 합계)
  count: number;  // 해당 기간 내 레코드 수
}
```

### 10.2 기존 함수 개선 (getMetricRecords)
-   단순 최신순 조회 대신, `limit` + `기간 선택` 옵션 추가
-   내부에서 데이터 수에 따라 **집계 단위 추천** 반환

---

## 11. Custom Metrics 차트 렌더링 전략

### 11.1 차트 타입 선택 로직

```typescript
function selectChartType(recordCount: number): ChartType {
  if (recordCount <= 60) return 'DotChart';
  if (recordCount <= 180) return 'LineChart';
  if (recordCount <= 730) return 'BarChart';
  return 'SummaryCard';
}

type ChartType = 'DotChart' | 'LineChart' | 'BarChart' | 'SummaryCard';
```

### 11.2 렌더링 시점
1.  클라이언트에서 데이터 개수 확인
2.  차트 유형/집계 결정
3.  렌더링

### 11.3 성능 최적화
-   필요 시, **Lazy Load** 또는 **Virtualization** 적용 (데이터 많을 때 성능 개선)

---

## 12. Custom Metrics 마이그레이션/호환성

### 12.1 호환성 원칙
-   **기존 DB 구조 유지**: 스키마 변경 없음
-   집계 함수 추가 및 UI/UX 개선만 적용
-   기존 단일 Dot Chart/Bar Chart도 그대로 사용 가능

### 12.2 추가 고려 사항
-   다중 사용자(`userId`) 및 펫(`petId`) 단위 지원
-   삭제 시 orphan 레코드 방지
-   향후 Line + Area + Sparklines 혼합 차트 확장 가능
-   줌/스크롤과 Tooltip으로 상세/요약 정보 동시 제공
