{
  "goal": "trial 상태 관리 로직을 서버 기준 SSOT로 정리하고 앱 재설치 시 중복 trial 사용 방지",
  "scope": [
    "apps/web/src/models/Subscription.ts",
    "apps/web/src/app/api/subscription/trial-start/route.ts",
    "apps/web/src/app/api/subscription/verify/route.ts",
    "apps/mobile/services/device.ts",
    "apps/mobile/services/subscription-ssot.ts",
    "apps/mobile/services/subscription.ts",
    "apps/mobile/services/SubscriptionManager.ts"
  ],
  "rules": [
    "/omo/omo_task_rules.md 를 절대 규칙으로 사용한다",
    "규칙을 요약하거나 생략하지 않는다",
    "보편적이고 대중적이며 안전한 리팩토링 패턴만 사용한다",
    "기존 코드 컨벤션과 아키텍처를 절대 기준으로 삼는다",
    "기존 컨벤션 문서는 docs/conventions 하위의 모든 문서를 참고할 것",
    "trial / payment / auth / subscription 영역은 항상 보수적으로 처리한다",
    "scope 외 파일은 절대 수정하지 않는다",
    "steps는 한 파일 기준으로 작게 나눈다",
    "기존에 구현되어 있는 모든 기능은 한치의 오차 없이 정상 동작해야 한다",
    "결제, 갱신, 무료 체험과 관련된 각 케이스의 UI/동작은 현재 구현된 결과에서 절대 변동이 없어야 한다"
  ],
  "steps": [
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/web/src/models/Subscription.ts",
      "description": "Mongoose 인덱스 중복 제거 - deviceId 필드에서 index: true 제거, schema.index() 하나만 유지하여 빌드 경고 해결"
    },
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/web/src/app/api/subscription/trial-start/route.ts",
      "description": "trial-start API 로직 정리 - deviceId가 없는 경우 오류 반환하도록 강화하여 중복 trial 방지 로직 명확화"
    },
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/web/src/app/api/subscription/verify/route.ts",
      "description": "verify API deviceId 블록 로직 강화 - deviceId 기반 블록 로직을 별도 함수로 분리하고 deviceId가 unknown인 경우 처리 로직 명확화"
    },
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/mobile/services/device.ts",
      "description": "deviceId 버전 정책 수정 - CURRENT_VERSION 상수 제거 및 버전 체크 로직 제거하여 앱 재설치 후에도 동일한 deviceId 유지"
    },
    {
      "action": "create",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/mobile/services/subscription-ssot.ts",
      "description": "SSOT 유틸리티 함수 분리 - 서버 통신 및 SSOT 판별 로직을 별도 모듈로 생성하여 subscription.ts 크기 감소 및 SRP 준수"
    },
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/mobile/services/subscription.ts",
      "description": "subscription.ts 리팩토링 - SSOT 관련 함수들을 subscription-ssot.ts로 이동하고 import만 남겨 코드 가독성 향상"
    },
    {
      "action": "modify",
      "file": "/Users/shkim/Desktop/Project/myorok/apps/mobile/services/SubscriptionManager.ts",
      "description": "SubscriptionManager import 수정 - 새로 생성된 subscription-ssot.ts에서 함수들을 import하도록 수정"
    }
  ],
  "test": "npm run build:web && cd /Users/shkim/Desktop/Project/myorok/apps/mobile && npx tsc --noEmit",
  "success_criteria": [
    "모든 테스트 통과 (Web 빌드, Mobile TypeScript 컴파일)",
    "Mongoose 중복 인덱스 경고 제거",
    "앱 재설치 후 deviceId 일관성 유지",
    "deviceId 기반 중복 trial 완전 차단",
    "기존 기능 동작 유지 (trial banner, subscription block screen 등)",
    "lint / type error 없음",
    "결제, 갱신, 무료 체험 관련 UI/동작 완전 보존"
  ],
  "failure_criteria": [
    "테스트 실패 (빌드 실패, TypeScript 에러)",
    "trial 중복 사용 가능 (앱 재설치 후)",
    "기존 UI/동작 변경 (trial banner, subscription block screen 등)",
    "scope 외 파일 수정 발생",
    "trial / payment / auth / subscription 관련 치명적 로그",
    "기존 기능 동작 훼손"
  ]
}
